{% extends "base.html" %}
{% load static %}

{% block title %}Top up - PlugHub{% endblock %}

{% block content %}
<section class="section dashboard">
    <div class="section-head">
        <h1>Top up</h1>
    </div>

    <div class="credit-panel">
        <div class="credit-heading">
            <span class="credit-pill">Current balance</span>
            <span class="credit-glow"></span>
        </div>
        <div class="credit-label">Credits available</div>
        <div class="credit-row">
            <div class="credit-value">{{ credit_balance }}</div>
        </div>
        <p class="credit-note">Complete your payment and our team will verify it—credits will reflect right after verification.</p>
    </div>

    <div class="support-card">
        <div>
            <div class="support-title">Need fast help with credits?</div>
            <p class="support-copy">We respond quickly so you can stay productive.</p>
            <div class="support-links">
                <a class="pill strong" href="mailto:paymentsupport@plughub-ims.com">paymentsupport@plughub-ims.com</a>
                <a class="pill ghost strong" href="https://wa.me/message/UU6IVO3RQSTEI1" target="_blank" rel="noopener">Chat on WhatsApp</a>
            </div>
        </div>
    </div>

    <div class="topup-table-wrap">
        <div class="topup-table-header">Select a pack</div>
        <table class="topup-table">
            <thead>
                <tr>
                    <th>Amount (PHP)</th>
                    <th>Credits</th>
                    <th>Top up</th>
                </tr>
            </thead>
            <tbody>
                {% for plan in plans %}
                <tr>
                    <td>₱{{ plan.amount }}</td>
                    <td>{{ plan.credits }} credits</td>
                    <td><button class="btn primary topup-action" data-topup data-amount="{{ plan.amount }}" data-credits="{{ plan.credits }}">Top up</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="topup-hint">Each pack instantly unlocks the listed credits. Payments are secured.</p>
    </div>

    <div class="topup-modal-backdrop" data-topup-modal hidden>
        <div class="topup-modal">
            <button class="close-btn" type="button" data-topup-close aria-label="Close modal">✕</button>
            <div class="topup-modal-body">
                <h3>Scan to top up</h3>
                <p class="topup-modal-copy">Scan the QR code below with GCash to complete your top up.</p>
                <div class="topup-instructions">
                    <p>Please quickly email your transfer receipt to our support team with your username.</p>
                    <div class="support-links inline">
                        <a class="pill strong" href="mailto:paymentsupport@plughub-ims.com">paymentsupport@plughub-ims.com</a>
                        <a class="pill ghost strong" href="https://wa.me/message/UU6IVO3RQSTEI1" target="_blank" rel="noopener">Chat on WhatsApp</a>
                    </div>
                </div>
                <div class="topup-qr">
                    <img src="{% static 'img/gcash-99.jpg' %}" alt="GCash QR" data-topup-img>
                </div>
                <div class="topup-modal-meta">
                    <div><strong>Amount:</strong> ₱<span data-topup-amount>99</span></div>
                    <div><strong>Credits:</strong> <span data-topup-credits>6</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="topup-modal-backdrop" data-topup-confirm hidden>
        <div class="topup-modal">
            <div class="topup-modal-body">
                <h3>Confirm top up</h3>
                <p class="topup-modal-copy">You still have <strong>{{ credit_balance }}</strong> credits. Are you sure you want to add more now?</p>
                <div class="topup-confirm-actions">
                    <button class="btn ghost" type="button" data-topup-cancel>Cancel</button>
                    <button class="btn primary" type="button" data-topup-continue>Continue</button>
                </div>
            </div>
        </div>
    </div>
</section>
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const creditBalance = parseInt('{{ credit_balance|default:0 }}', 10) || 0;
    const backdrop = document.querySelector('[data-topup-modal]');
    const img = document.querySelector('[data-topup-img]');
    const amt = document.querySelector('[data-topup-amount]');
    const creds = document.querySelector('[data-topup-credits]');
    const closeBtn = document.querySelector('[data-topup-close]');
    const buttons = document.querySelectorAll('[data-topup]');
    const confirmModal = document.querySelector('[data-topup-confirm]');
    const confirmCancel = document.querySelector('[data-topup-cancel]');
    const confirmContinue = document.querySelector('[data-topup-continue]');
    let pendingAmount = null;
    let pendingCredits = null;

    const qrMap = {
        99: "{% static 'img/gcash-99.jpg' %}",
        200: "{% static 'img/gcash-200.jpg' %}",
        400: "{% static 'img/gcash-400.jpg' %}",
        800: "{% static 'img/gcash-800.jpg' %}",
        1600: "{% static 'img/gcash-1600.jpg' %}",
    };

    function openModal(amount, credits) {
        if (img && qrMap[amount]) img.src = qrMap[amount];
        if (amt) amt.textContent = amount;
        if (creds) creds.textContent = credits;
        if (backdrop) backdrop.hidden = false;
    }

    function closeModal() {
        if (backdrop) backdrop.hidden = true;
    }

    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            const amount = parseInt(btn.getAttribute('data-amount'), 10);
            const credits = btn.getAttribute('data-credits');
            if (creditBalance > 1) {
                pendingAmount = amount;
                pendingCredits = credits;
                if (confirmModal) confirmModal.hidden = false;
            } else {
                openModal(amount, credits);
            }
        });
    });

    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    if (backdrop) {
        backdrop.addEventListener('click', (e) => {
            if (e.target === backdrop) closeModal();
        });
    }
    if (confirmCancel) {
        confirmCancel.addEventListener('click', () => {
            if (confirmModal) confirmModal.hidden = true;
            pendingAmount = null;
            pendingCredits = null;
        });
    }
    if (confirmContinue) {
        confirmContinue.addEventListener('click', () => {
            if (confirmModal) confirmModal.hidden = true;
            if (pendingAmount !== null && pendingCredits !== null) {
                openModal(pendingAmount, pendingCredits);
            }
            pendingAmount = null;
            pendingCredits = null;
        });
    }
    if (confirmModal) {
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                confirmModal.hidden = true;
                pendingAmount = null;
                pendingCredits = null;
            }
        });
    }
});
</script>
{% endblock %}
{% endblock %}
